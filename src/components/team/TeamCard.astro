---
import { Icon } from "astro-icon/components";
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";

type ContributorData =
  | CollectionEntry<"team">["data"]
  | CollectionEntry<"contributors">["data"];

interface Props {
  slug: string;
  name: ContributorData["name"];
  contacts: ContributorData["contacts"];
  avatar: ContributorData["avatar"];
  mode?: "link" | "display";
}

const { name, contacts, avatar, slug, mode = "link" } = Astro.props;
const isLinkMode = mode === "link";
---

<div
  class:list={[
    "outer-box group relative z-10 flex w-80 w-[500px] min-w-72 max-w-full flex-col gap-4 rounded-xl md:pb-[1.125rem]",
    isLinkMode ? "link-mode" : "display-mode",
  ]}
>
  <h3
    class="header-row m-0 flex items-center gap-3 self-center text-xl not-italic"
    id={`${slug}`}
  >
    {
      isLinkMode ? (
        <a
          href={`/contributors/${slug}`}
          class="card-link flex items-center gap-4 !no-underline"
        >
          <span class="card-name -mt-1 font-zeitung text-fujo-pink">
            {name}
          </span>
          <Image
            class="rounded-xl object-cover"
            width={40}
            height={40}
            src={avatar}
            alt="Avatar of the contributor"
          />
          <Icon
            name="lucide:arrow-right"
            size={20}
            class="arrow-icon -ml-2 text-fujo-pink opacity-40 transition-all"
          />
        </a>
      ) : (
        <div class="flex items-center gap-4">
          <span class="-mt-1 font-zeitung text-fujo-pink">{name}</span>
          <Image
            class="rounded-xl object-cover"
            width={40}
            height={40}
            src={avatar}
            alt="Avatar of the contributor"
          />
        </div>
      )
    }
  </h3>
  {
    !isLinkMode && (
      <button
        class="copy-button absolute right-3 top-3 flex rounded-lg p-2 text-fujo-pink opacity-40 transition-all hover:opacity-100"
        data-url={`/contributors/${slug}`}
        aria-label="Copy link to this profile"
      >
        <Icon name="lucide:copy" size={18} class="copy-icon" />
        <Icon name="lucide:check" size={18} class="check-icon hidden" />
      </button>
    )
  }
  <ul class="flex flex-col p-4 pb-2.5 pt-0 md:p-6 md:pb-[1.125rem] md:pt-0">
    {
      contacts.map((contact) => {
        const url = new URL(contact.url);
        return (
          <li class="contact-row mt-0">
            <a
              href={contact.url}
              class="group/contact flex items-center gap-3 py-1.5 !no-underline"
            >
              <div class="flex rounded-lg bg-fujo-purple/10 p-2 group-hover/contact:bg-fujo-purple/20">
                <Icon
                  size={24}
                  aria-labelledby={
                    contact.platform !== "web" ? "platform" : undefined
                  }
                  aria-label={
                    contact.platform === "web" ? "website" : undefined
                  }
                  name={contact.icon ?? "world-www"}
                  class="flex-shrink-0"
                />
              </div>
              {contact.platform !== "web" && (
                <span class="sr-only" id="platform">
                  {contact.platform}:{" "}
                </span>
              )}
              <span class="-mt-1 truncate">
                {contact.username
                  ? `@${contact.username}`
                  : `${url.hostname}${url.pathname == "/" ? "" : url.pathname}`}
              </span>
            </a>
          </li>
        );
      })
    }
  </ul>
</div>

<script>
  document.querySelectorAll(".copy-button").forEach((button) => {
    button.addEventListener("click", async () => {
      const url = new URL(
        button.getAttribute("data-url") || "",
        window.location.origin
      );
      const copyIcon = button.querySelector(".copy-icon");
      const checkIcon = button.querySelector(".check-icon");

      try {
        await navigator.clipboard.writeText(url.toString());
        copyIcon?.classList.add("hidden");
        checkIcon?.classList.remove("hidden");
        setTimeout(() => {
          copyIcon?.classList.remove("hidden");
          checkIcon?.classList.add("hidden");
        }, 2000);
      } catch (err) {
        console.error("Failed to copy:", err);
      }
    });
  });
</script>

<style>
  @property --gradient-angle {
    syntax: "<angle>";
    initial-value: 0deg;
    inherits: false;
  }

  .outer-box {
    border: 2px solid transparent;
    background:
      linear-gradient(white, white) padding-box,
      conic-gradient(
          from var(--gradient-angle),
          rgba(255, 33, 233, 0.8),
          rgba(67, 96, 247, 0.8),
          rgba(255, 33, 233, 0.8),
          rgba(67, 96, 247, 0.8),
          rgba(255, 33, 233, 0.8)
        )
        border-box;
    transition:
      box-shadow 0.2s ease,
      transform 0.2s ease;
  }

  .link-mode {
    cursor: pointer;
  }

  .link-mode .card-link::after {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: 0.75rem;
  }

  .link-mode:hover:not(:has(.contact-row a:hover)) .header-row {
    background: linear-gradient(
      to right,
      rgba(255, 33, 233, 0.15),
      rgba(67, 96, 247, 0.1)
    );
  }

  .link-mode:hover:not(:has(.contact-row a:hover)) .arrow-icon {
    opacity: 1;
    transform: translateX(0.25rem);
  }

  .link-mode:hover:not(:has(.contact-row a:hover)) .card-name {
    text-decoration: underline;
  }

  .link-mode:hover {
    box-shadow: 0 0 15px rgba(255, 33, 233, 0.15);
    transform: translateY(-4px) scale(1.02);
  }

  .display-mode {
    cursor: default;
  }

  .copy-button:hover {
    background: linear-gradient(
      to right,
      rgba(255, 33, 233, 0.15),
      rgba(67, 96, 247, 0.1)
    );
  }

  /* Shared styles */
  .header-row {
    border-radius: 0.5rem;
    margin-top: 0.5rem;
    padding: 0.5rem 1rem;
    transition: background 0.15s ease;
  }

  .contact-row {
    border-radius: 0.5rem;
    padding-left: 0.5rem;
    transition: background 0.15s ease;
  }

  .contact-row a {
    position: relative;
    z-index: 1;
  }

  .contact-row:has(a:hover) {
    background: linear-gradient(
      to right,
      rgba(255, 33, 233, 0.2),
      rgba(67, 96, 247, 0.15)
    );
  }

  .outer-box:global(:has(*:target)) h3 {
    font-weight: bold;
  }

  .outer-box:global(:has(*:target)) {
    background:
      linear-gradient(#ffd8fb, #ffd8fb) padding-box,
      conic-gradient(
          from var(--gradient-angle),
          rgba(255, 33, 233, 0.8),
          rgba(67, 96, 247, 0.8),
          rgba(255, 33, 233, 0.8),
          rgba(67, 96, 247, 0.8),
          rgba(255, 33, 233, 0.8)
        )
        border-box;
  }

  @media (prefers-reduced-motion: no-preference) {
    .outer-box {
      animation: rotate-gradient 6s linear infinite;
    }

    /* Stagger animation start for each card */
    .outer-box:nth-child(6n + 1) {
      animation-delay: 0s;
    }
    .outer-box:nth-child(6n + 2) {
      animation-delay: -1s;
    }
    .outer-box:nth-child(6n + 3) {
      animation-delay: -2s;
    }
    .outer-box:nth-child(6n + 4) {
      animation-delay: -3s;
    }
    .outer-box:nth-child(6n + 5) {
      animation-delay: -4s;
    }
    .outer-box:nth-child(6n + 6) {
      animation-delay: -5s;
    }

    @keyframes rotate-gradient {
      to {
        --gradient-angle: 360deg;
      }
    }
  }
</style>
